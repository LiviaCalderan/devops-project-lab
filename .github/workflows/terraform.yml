name: Terraform CI/CD

on:
  # Manual Trigger
  workflow_dispatch:
    inputs:
      apply:
        description: 'Executar Terraform Apply?'
        required: true
        default: 'FALSE'
        type: choice
        options:
          - 'TRUE'
          - 'FALSE'

      destroy:
        description: 'Executar Terraform Destroy?'
        required: true
        default: 'FALSE'
        type: choice
        options:
          - 'TRUE'
          - 'FALSE'

      plan_destroy:
        description: 'Planejar o Terraform Destroy?'
        required: true
        default: 'FALSE'
        type: choice
        options:
          - 'TRUE'
          - 'FALSE'

permissions:
  contents: read
  id-token: write

jobs:
  job1:
    name: Terraform CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6.0.0
        with:
          aws-region: us-east-2
          role-to-assume: arn:aws:iam::887675945755:role/GithubInfraRole

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -out=tfplan.tfout -input=false
        env:
          TF_VAR_aws_region: ${{ vars.TF_VAR_aws_region }}
          TF_VAR_project_name: ${{ vars.TF_VAR_project_name }}
          TF_VAR_instance_type: ${{ vars.TF_VAR_instance_type }}
          TF_VAR_ecr_repository_name: ${{ vars.TF_VAR_ecr_repository_name }}
          TF_VAR_state_bucket: ${{ vars.TF_VAR_state_bucket }}

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve -input=false tfplan.tfout
        if: ${{github.event.inputs.apply == 'TRUE'}}

      - name: Plan Destroy
        working-directory: ./terraform
        run: terraform plan -destroy -input=false -out=tfplan.tfout
        if: ${{github.event.inputs.plan_destroy == 'TRUE'}}


      - name: Terraform Destroy
        working-directory: ./terraform
        run: terraform apply -destroy -auto-approve -input=false tfplan.tfout
        if: ${{github.event.inputs.destroy == 'TRUE'}}
