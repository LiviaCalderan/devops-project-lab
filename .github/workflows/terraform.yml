name: Terraform CI/CD

on:
  # Manual Trigger
  workflow_dispatch:
    inputs:
      apply:
        description: 'Executar Terraform Apply?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'TRUE'
          - 'FALSE'

permissions:
  contents: read
  id-token: write

jobs:
  job1:
    name: Terraform CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6.0.0
        with:
          aws-region: us-east-2
          role-to-assume: arn:aws:iam::887675945755:role/GithubInfraRole

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -var-file=envs/prod.tfvars -out=tfplan -input=false

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve -input=false tfplan
        if: ${{github.event.inputs.apply == 'TRUE'}}
